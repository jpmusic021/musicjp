<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BeatHub - Music & Video Downloads</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; color: #e0e0e0; }
        .sidebar { transition: width 0.3s ease; }
        .sidebar-collapsed { width: 5rem; }
        .sidebar-expanded { width: 16rem; }
        .sidebar-link-text { transition: opacity 0.3s ease; }
        .sidebar-collapsed .sidebar-link-text { opacity: 0; pointer-events: none; }
        .sidebar-expanded .sidebar-link-text { opacity: 1; }
        .content-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .card-hover-effect { transition: transform 0.2s, box-shadow 0.2s; }
        .card-hover-effect:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -2px rgba(0,0,0,.2); }
        .btn-primary { background-color: #6d28d9; color: white; }
        .btn-primary:hover { background-color: #5b21b6; }
        .btn-secondary { background-color: #374151; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar sidebar-expanded bg-black text-white flex flex-col z-20">
        <div class="flex items-center justify-between p-4 border-b border-gray-800">
            <span id="logo-text" class="sidebar-link-text font-bold text-xl text-purple-400">BeatHub</span>
            <button id="toggle-sidebar" class="text-gray-400 hover:text-white">
                <i class="fas fa-bars"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="#" onclick="showPage('home')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-home w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">Home</span></a>
            <a href="#" onclick="showPage('home')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-fire w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">Trending</span></a>
            <a href="#" onclick="showPage('home')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-music w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">Music</span></a>
            <a href="#" onclick="showPage('home')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-video w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">Videos</span></a>
            <a href="#" onclick="showPage('profile')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-download w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">My Downloads</span></a>
        </nav>
        <div class="p-4 border-t border-gray-800">
             <a href="#" onclick="showPage('login')" class="flex items-center p-3 rounded-lg hover:bg-gray-800"><i class="fas fa-shield-halved w-8 text-center text-lg"></i><span class="sidebar-link-text ml-4">Admin Login</span></a>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-gray-900/80 backdrop-blur-sm shadow-lg flex items-center justify-between p-4 z-10">
            <div class="flex-1 max-w-2xl">
                <div class="relative">
                    <input id="search" type="text" placeholder="Search for music, videos, artists..." class="w-full bg-gray-800 text-white rounded-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
            </div>
            <div class="flex items-center space-x-6 ml-6">
                <i class="fas fa-bell text-xl text-gray-400 hover:text-white cursor-pointer"></i>
                <img onclick="showPage('profile')" src="https://placehold.co/40x40/7c3aed/ffffff?text=U" alt="User Profile" class="w-10 h-10 rounded-full cursor-pointer border-2 border-transparent hover:border-purple-500">
            </div>
        </header>

        <!-- Page Content -->
        <main id="main-content" class="flex-1 overflow-y-auto p-6 md:p-8">

            <!-- Home Page -->
            <div id="home" class="page">
                <section>
                    <h2 class="text-2xl font-bold mb-4">Featured Videos</h2>
                    <div id="videos-grid" class="content-grid"></div>
                </section>

                <section class="mt-12">
                    <h2 class="text-2xl font-bold mb-4">Latest Music Tracks</h2>
                    <div id="music-grid" class="content-grid"></div>
                </section>
            </div>

            <!-- Profile Page -->
            <div id="profile" class="page hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="bg-gray-900 rounded-lg shadow-xl p-8">
                        <div class="flex items-center space-x-8">
                            <img src="https://placehold.co/128x128/7c3aed/ffffff?text=U" alt="User Profile" class="w-32 h-32 rounded-full border-4 border-purple-500">
                            <div>
                                <h1 id="profile-name" class="text-4xl font-bold">Guest</h1>
                                <p id="profile-email" class="text-gray-400">guest@example.com</p>
                                <span id="profile-plan" class="inline-block bg-gray-600 text-white text-xs font-bold px-3 py-1 rounded-full mt-2">GUEST</span>
                            </div>
                        </div>
                        <div class="mt-8 border-t border-gray-700 pt-8">
                            <h3 class="text-2xl font-bold mb-4">My Purchases</h3>
                            <div id="purchases-list" class="space-y-4">
                                <p class="text-gray-400">No purchases yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Login Page -->
            <div id="login" class="page hidden">
                <div class="max-w-md mx-auto mt-10">
                    <div class="bg-gray-900 rounded-lg shadow-xl p-8">
                        <h2 class="text-2xl font-bold text-center mb-6">Admin Login</h2>
                        <form id="login-form">
                            <div class="mb-4">
                                <label for="email" class="block text-gray-400 mb-2">Email</label>
                                <input type="email" id="email" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            <div class="mb-6">
                                <label for="password" class="block text-gray-400 mb-2">Password</label>
                                <input type="password" id="password" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                            </div>
                            <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden">Invalid email or password.</p>
                            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-bold">Login</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Admin Page -->
            <div id="admin" class="page hidden">
                <h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gray-900 p-6 rounded-lg"><h3 class="text-gray-400 text-sm font-medium">Total Revenue</h3><p id="stat-revenue" class="text-3xl font-bold mt-1">₹0</p></div>
                    <div class="bg-gray-900 p-6 rounded-lg"><h3 class="text-gray-400 text-sm font-medium">Total Downloads</h3><p id="stat-downloads" class="text-3xl font-bold mt-1">0</p></div>
                    <div class="bg-gray-900 p-6 rounded-lg"><h3 class="text-gray-400 text-sm font-medium">New Users</h3><p id="stat-users" class="text-3xl font-bold mt-1">0</p></div>
                    <div class="bg-gray-900 p-6 rounded-lg"><h3 class="text-gray-400 text-sm font-medium">Items for Sale</h3><p id="stat-items" class="text-3xl font-bold mt-1">0</p></div>
                </div>

                <div class="mt-8 bg-gray-900 rounded-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Manage Content</h2>
                        <button onclick="showPage('upload-content')" class="btn-primary py-2 px-4 rounded-lg flex items-center space-x-2"><i class="fas fa-plus"></i><span>Add New Item</span></button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead><tr class="border-b border-gray-700"><th class="p-3">Title</th><th class="p-3">Type</th><th class="p-3">Access</th><th class="p-3">Price</th><th class="p-3">Status</th><th class="p-3">Actions</th></tr></thead>
                            <tbody id="content-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Upload Content Page -->
            <div id="upload-content" class="page hidden">
                <div class="max-w-2xl mx-auto">
                    <button onclick="showPage('admin')" class="btn-secondary mb-6 py-2 px-4 rounded-lg flex items-center space-x-2"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></button>
                    <div class="bg-gray-900 rounded-lg shadow-xl p-8">
                        <h2 class="text-2xl font-bold mb-6">Upload New Media</h2>
                        <form id="upload-form">
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Title</label><input type="text" id="title" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Artist</label><input type="text" id="artist" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Type</label>
                                <select id="type" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Music">Music</option>
                                    <option value="Video">Video</option>
                                    <option value="Sound Effect">Sound Effect</option>
                                    <option value="Tutorial">Tutorial</option>
                                </select>
                            </div>
                             <div class="mb-4"><label class="block text-gray-400 mb-2">YouTube Video ID (for thumbnails)</label><input type="text" id="youtubeId" placeholder="e.g. dQw4w9WgXcQ" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Access</label>
                                <select id="access" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="free">Free</option>
                                    <option value="paid">Paid</option>
                                </select>
                            </div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Price (₹) — for Paid</label><input type="number" id="price" min="0" step="1" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="e.g. 49"></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Drive Link (optional)</label><input type="url" id="drive-link" placeholder="https://..." class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"></div>
                            <div class="mb-6"><label class="block text-gray-400 mb-2">Upload File (optional)</label><input type="file" id="file" accept="audio/*,video/*" class="w-full"></div>
                            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-bold">Upload</button>
                            <p id="upload-status" class="text-sm text-gray-400 mt-3"></p>
                            <div class="w-full bg-gray-800 h-2 rounded mt-2 overflow-hidden"><div id="upload-progress" class="bg-purple-600 h-2 w-0"></div></div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Edit Content Page -->
            <div id="edit-content" class="page hidden">
                <div class="max-w-2xl mx-auto">
                    <button onclick="showPage('admin')" class="btn-secondary mb-6 py-2 px-4 rounded-lg flex items-center space-x-2"><i class="fas fa-arrow-left"></i><span>Back to Dashboard</span></button>
                    <div class="bg-gray-900 rounded-lg shadow-xl p-8">
                        <h2 class="text-2xl font-bold mb-6">Edit Media</h2>
                        <form id="edit-form">
                            <input type="hidden" id="edit-item-id">
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Title</label><input type="text" id="edit-title" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Type</label><input type="text" id="edit-type" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500" required></div>
                             <div class="mb-4"><label class="block text-gray-400 mb-2">YouTube Video ID</label><input type="text" id="edit-youtubeId" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Access</label><select id="edit-access" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"><option value="free">Free</option><option value="paid">Paid</option></select></div>
                            <div class="mb-4"><label class="block text-gray-400 mb-2">Price (₹)</label><input type="number" id="edit-price" class="w-full bg-gray-800 text-white rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-purple-500"></div>
                            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-bold">Update</button>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal-overlay hidden">
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 max-w-sm mx-auto">
            <h3 class="text-xl font-bold text-center">Are you sure?</h3>
            <p class="text-gray-400 text-center my-4">Do you really want to delete this item? This process cannot be undone.</p>
            <div class="flex justify-center space-x-4 mt-6">
                <button onclick="closeDeleteModal()" class="btn-secondary py-2 px-6 rounded-lg">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-6 rounded-lg font-bold">Delete</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // ====== Firebase v9+ Modular SDK ======
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, orderBy, query, doc, deleteDoc, updateDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

        // --- TODO: Replace with your Firebase project config ---
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ====== UI Helpers ======
        const pages = document.querySelectorAll('.page');
        const mainContent = document.getElementById('main-content');
        window.showPage = (pageId) => { pages.forEach(p => p.id === pageId ? p.classList.remove('hidden') : p.classList.add('hidden')); mainContent.scrollTop = 0; }

        // Sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const toggleButton = document.getElementById('toggle-sidebar');
        const logoText = document.getElementById('logo-text');
        toggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-collapsed');
            sidebar.classList.toggle('sidebar-expanded');
            if (sidebar.classList.contains('sidebar-collapsed')) { logoText.style.display = 'none'; }
            else { setTimeout(() => { logoText.style.display = 'inline'; }, 150); }
        });

        // ====== Admin Login (Simple) ======
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (email === 'jjayuyt@gmail.com' && password === 'Jatystr@021') {
                loginError.classList.add('hidden');
                showPage('admin');
            } else {
                loginError.classList.remove('hidden');
            }
        });

        // ====== Firestore: Live Collections ======
        const mediaCol = collection(db, 'media');
        const videosGrid = document.getElementById('videos-grid');
        const musicGrid = document.getElementById('music-grid');

        function mediaCard(item) {
            const isPaid = item.access === 'paid' && Number(item.price) > 0;
            const priceBadge = isPaid ? `<span class="font-bold text-green-400">₹${Number(item.price).toFixed(0)}</span>` : `<span class="font-bold text-blue-400">Free</span>`;
            
            let image;
            if (item.youtubeId && item.type === 'Video') {
                image = `https://img.youtube.com/vi/${item.youtubeId}/hqdefault.jpg`;
            } else {
                image = item.thumbnail || (item.type === 'Video' ? `https://placehold.co/600x338/${Math.floor(Math.random()*899999+100000).toString(16)}/ffffff?text=${encodeURIComponent(item.title)}` : `https://placehold.co/600x600/${Math.floor(Math.random()*899999+100000).toString(16)}/ffffff?text=ALBUM`);
            }

            return `
                <div class="bg-gray-900 rounded-lg overflow-hidden card-hover-effect cursor-pointer">
                    <img src="${image}" alt="Thumbnail" class="w-full h-40 object-cover">
                    <div class="p-4">
                        <h3 class="font-bold text-lg">${item.title}</h3>
                        <p class="text-gray-400 text-sm">${item.artist || ''}</p>
                        <div class="flex justify-between items-center mt-2 text-sm text-gray-400">
                            <span>${item.type}</span>
                            ${priceBadge}
                        </div>
                        <div class="mt-3 flex gap-2">
                            <button class="btn-secondary py-2 px-3 rounded-full text-sm" onclick="previewItem('${item.id}')"><i class="fa-solid fa-play"></i> Preview</button>
                            ${isPaid ? `<button class="btn-primary py-2 px-3 rounded-full text-sm" onclick="buyItem('${item.id}')"><i class="fa-solid fa-bag-shopping"></i> Buy</button>` : `<a href="${item.url || '#'}" target="_blank" class="btn-primary py-2 px-3 rounded-full text-sm inline-flex items-center"><i class='fa-solid fa-download mr-2'></i>Download</a>`}
                        </div>
                    </div>
                </div>`;
        }

        onSnapshot(query(mediaCol, where('status','==','published'), where('type','==','Video'), orderBy('createdAt','desc')), (snap) => {
            videosGrid.innerHTML = snap.empty ? '<p class="text-gray-400 col-span-full">No videos have been uploaded yet.</p>' : '';
            snap.forEach(docu => videosGrid.insertAdjacentHTML('beforeend', mediaCard({ id: docu.id, ...docu.data() })));
        });
        onSnapshot(query(mediaCol, where('status','==','published'), where('type','==','Music'), orderBy('createdAt','desc')), (snap) => {
            musicGrid.innerHTML = snap.empty ? '<p class="text-gray-400 col-span-full">No music has been uploaded yet.</p>' : '';
            snap.forEach(docu => musicGrid.insertAdjacentHTML('beforeend', mediaCard({ id: docu.id, ...docu.data() })));
        });

        // ====== Admin: table live ======
        const contentBody = document.getElementById('content-table-body');
        let currentDeleteId = null;
        const deleteModal = document.getElementById('delete-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        function rowTemplate(item){
            const badge = item.status === 'published' ? '<span class="bg-green-500 text-white px-2 py-1 text-xs rounded-full">Published</span>' : '<span class="bg-yellow-500 text-white px-2 py-1 text-xs rounded-full">Draft</span>';
            const access = item.access === 'paid' ? 'Paid' : 'Free';
            const price = item.access === 'paid' ? `₹${Number(item.price||0).toFixed(0)}` : '—';
            return `<tr id="row-${item.id}" class="border-b border-gray-800">
                <td class="p-3">${item.title}</td> <td class="p-3">${item.type}</td> <td class="p-3">${access}</td> <td class="p-3">${price}</td> <td class="p-3">${badge}</td>
                <td class="p-3 space-x-2">
                    <button class="text-blue-400 hover:text-blue-300" data-edit-id="${item.id}"><i class="fas fa-edit"></i></button>
                    <button class="text-red-500 hover:text-red-400" data-delete-id="${item.id}" data-storage-path="${item.storagePath || ''}"><i class="fas fa-trash"></i></button>
                </td>
            </tr>`;
        }

        onSnapshot(query(mediaCol, orderBy('createdAt','desc')), (snap) => {
            contentBody.innerHTML = snap.empty ? '<tr><td colspan="6" class="p-4 text-center text-gray-400">No content uploaded yet.</td></tr>' : '';
            let itemsForSale = 0, downloads = 0, revenue = 0;
            snap.forEach(docu => {
                const item = { id: docu.id, ...docu.data() };
                if(item.access==='paid') itemsForSale++;
                if(item.downloads) downloads += Number(item.downloads);
                if(item.revenue) revenue += Number(item.revenue);
                contentBody.insertAdjacentHTML('beforeend', rowTemplate(item));
            });
            document.getElementById('stat-items').textContent = String(itemsForSale);
            document.getElementById('stat-downloads').textContent = String(downloads);
            document.getElementById('stat-revenue').textContent = `₹${revenue.toFixed(0)}`;
        });
        
        contentBody.addEventListener('click', (e) => {
            const delBtn = e.target.closest('[data-delete-id]');
            const editBtn = e.target.closest('[data-edit-id]');
            if (delBtn) { currentDeleteId = delBtn.dataset.deleteId; deleteModal.classList.remove('hidden'); }
            if (editBtn) { openEditForm(editBtn.dataset.editId); }
        });
        window.closeDeleteModal = () => { currentDeleteId = null; deleteModal.classList.add('hidden'); };
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!currentDeleteId) return;
            try {
                const row = document.getElementById(`row-${currentDeleteId}`);
                const storagePath = row?.querySelector('[data-delete-id]')?.dataset.storagePath;
                await deleteDoc(doc(db, 'media', currentDeleteId));
                if (storagePath) { try { await deleteObject(sRef(storage, storagePath)); } catch(err) { console.error("Error deleting file from storage:", err) } }
            } finally { closeDeleteModal(); }
        });

        // ====== Upload flow ======
        const uploadForm = document.getElementById('upload-form');
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value.trim();
            const artist = document.getElementById('artist').value.trim();
            const type = document.getElementById('type').value;
            const youtubeId = document.getElementById('youtubeId').value.trim();
            const access = document.getElementById('access').value;
            const price = Number(document.getElementById('price').value || 0);
            const date = new Date().toLocaleString(); // Automatically get current date and time
            const driveLink = document.getElementById('drive-link').value.trim();
            const file = document.getElementById('file').files[0];
            const uploadStatus = document.getElementById('upload-status');
            const uploadProgress = document.getElementById('upload-progress');

            uploadStatus.textContent = 'Creating item...';
            const docRef = await addDoc(mediaCol, { title, artist, type, youtubeId, access, price, status: 'published', date, url: driveLink, storagePath: '', createdAt: serverTimestamp(), downloads: 0, revenue: 0 });
            
            if (file) {
                const path = `media/${docRef.id}/${file.name}`;
                const fileRef = sRef(storage, path);
                const task = uploadBytesResumable(fileRef, file);
                await new Promise((resolve, reject) => {
                    task.on('state_changed', (snap) => {
                        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
                        uploadProgress.style.width = pct + '%';
                        uploadStatus.textContent = `Uploading ${pct}%...`;
                    }, reject, resolve);
                });
                const url = await getDownloadURL(task.snapshot.ref);
                const storagePath = task.snapshot.ref.fullPath;
                await updateDoc(doc(db, 'media', docRef.id), { url, storagePath });
            }

            uploadStatus.textContent = 'Uploaded successfully!';
            uploadForm.reset();
            uploadProgress.style.width = '0%';
            setTimeout(() => showPage('admin'), 1000);
        });

        // ====== Edit flow ======
        const editForm = document.getElementById('edit-form');
        const openEditForm = async (id) => {
            showPage('edit-content');
            const dref = doc(db, 'media', id);
            const snap = await getDoc(dref);
            const data = snap.data();
            document.getElementById('edit-item-id').value = id;
            document.getElementById('edit-title').value = data.title || '';
            document.getElementById('edit-type').value = data.type || '';
            document.getElementById('edit-youtubeId').value = data.youtubeId || '';
            document.getElementById('edit-access').value = data.access || 'free';
            document.getElementById('edit-price').value = Number(data.price || 0);
        };
        window.openEditForm = openEditForm;

        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-item-id').value;
            const title = document.getElementById('edit-title').value.trim();
            const type = document.getElementById('edit-type').value.trim();
            const youtubeId = document.getElementById('edit-youtubeId').value.trim();
            const access = document.getElementById('edit-access').value;
            const price = Number(document.getElementById('edit-price').value || 0);
            await updateDoc(doc(db, 'media', id), { title, type, youtubeId, access, price });
            showPage('admin');
        });

        // ====== Public actions (placeholders) ======
        window.previewItem = (id) => { alert('Preview coming soon for item ' + id); };
        window.buyItem = (id) => { alert('Integrate payment gateway here. Item: ' + id); };

        // ====== Search filter (client-side) ======
        document.getElementById('search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#videos-grid > div, #music-grid > div').forEach(card => {
                card.style.display = card.textContent.toLowerCase().includes(q) ? '' : 'none';
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => { showPage('home'); });
    </script>

</body>
</html>
